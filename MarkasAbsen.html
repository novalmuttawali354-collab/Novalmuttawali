<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Staff - MarkasWd</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f0d;
            --bg-secondary: #111916;
            --fg: #e8f0ec;
            --muted: #6b7c74;
            --accent: #00d47b;
            --accent-secondary: #00a060;
            --accent-glow: rgba(0, 212, 123, 0.3);
            --card: #151d19;
            --border: #243028;
            --danger: #ff4757;
            --warning: #ffa502;
            --info: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Background & Particles */
        .bg-pattern {
            position: fixed; inset: 0; z-index: 0; overflow: hidden;
        }
        .bg-pattern::before {
            content: ''; position: absolute; inset: -50%;
            background: radial-gradient(circle at 20% 30%, var(--accent-glow) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(0, 150, 100, 0.15) 0%, transparent 40%);
            animation: bgPulse 15s ease-in-out infinite;
        }
        .grid-lines {
            position: absolute; inset: 0;
            background-image: linear-gradient(var(--border) 1px, transparent 1px),
                              linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px; opacity: 0.3;
            mask-image: radial-gradient(ellipse at center, black 20%, transparent 70%);
        }
        @keyframes bgPulse { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.1) rotate(5deg); opacity: 0.8; } }
        
        .particle {
            position: absolute; width: 4px; height: 4px;
            background: var(--accent); border-radius: 50%; opacity: 0.6;
            animation: float 20s linear infinite;
            box-shadow: 0 0 10px var(--accent);
        }
        @keyframes float { 0% { transform: translateY(100vh) translateX(0); opacity: 0; } 10% { opacity: 0.6; } 90% { opacity: 0.6; } 100% { transform: translateY(-100vh) translateX(100px); opacity: 0; } }

        .main-container { position: relative; z-index: 10; min-height: 100vh; padding: 1.5rem; }

        /* Connection Status Bar */
        .connection-bar {
            position: fixed; top: 0; left: 0; right: 0; padding: 0.5rem;
            font-size: 0.7rem; text-align: center; z-index: 9999;
            display: none; justify-content: center; align-items: center; gap: 0.5rem;
            font-weight: 500; letter-spacing: 0.05em;
        }
        .connection-bar.online { background: var(--accent); color: var(--bg); display: flex; }
        .connection-bar.offline { background: var(--danger); color: white; display: flex; }

        /* Navigation */
        .nav-tabs {
            display: flex; gap: 0.5rem; margin-bottom: 2rem; background: var(--card);
            padding: 0.5rem; border-radius: 16px; border: 1px solid var(--border);
            max-width: 650px; margin-left: auto; margin-right: auto;
        }
        .nav-tab {
            flex: 1; padding: 0.875rem 1rem; background: transparent; border: none;
            border-radius: 12px; color: var(--muted); font-family: inherit;
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center;
            justify-content: center; gap: 0.5rem;
        }
        .nav-tab:hover { color: var(--fg); background: rgba(255,255,255,0.05); }
        .nav-tab.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); color: var(--bg); box-shadow: 0 4px 15px var(--accent-glow); }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Common */
        .card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 20px; backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .brand { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; justify-content: center; }
        .brand-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px var(--accent-glow); }
        .brand-text h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .brand-text span { font-size: 0.8rem; color: var(--muted); font-weight: 400; }

        .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0, 212, 123, 0.1); border: 1px solid rgba(0, 212, 123, 0.3); border-radius: 100px; font-size: 0.8rem; color: var(--accent); margin-bottom: 1.5rem; }
        .status-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

        /* Form Styles */
        .form-group { margin-bottom: 1.25rem; animation: fadeInUp 0.6s ease-out backwards; }
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.15s; }
        .form-group:nth-child(3) { animation-delay: 0.2s; }
        .form-group:nth-child(4) { animation-delay: 0.25s; }
        .form-group:nth-child(5) { animation-delay: 0.3s; }
        .form-group:nth-child(6) { animation-delay: 0.35s; }

        .form-label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 1rem 1.25rem; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; color: var(--fg); font-family: inherit; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }
        .form-input::placeholder { color: var(--muted); opacity: 0.6; }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7c74' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.25rem; cursor: pointer; }

        .time-display { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg) 100%); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; }
        .time-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); letter-spacing: 0.05em; }
        .date-value { font-size: 0.8rem; color: var(--muted); }

        .shift-info { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg) 100%); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; }
        .shift-info-label { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem; }
        .shift-info-value { font-size: 1rem; font-weight: 600; }
        .shift-info-value.on-time { color: var(--accent); }
        .shift-info-value.late { color: var(--danger); }

        .btn-checkin { width: 100%; padding: 1.25rem 2rem; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border: none; border-radius: 14px; color: var(--bg); font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .btn-checkin::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%); transform: translateX(-100%); transition: transform 0.5s ease; }
        .btn-checkin:hover::before { transform: translateX(100%); }
        .btn-checkin:hover { transform: translateY(-2px); box-shadow: 0 15px 40px var(--accent-glow); }
        .btn-checkin:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .spinner { width: 20px; height: 20px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 0.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .message { padding: 1rem 1.25rem; border-radius: 12px; margin-top: 1rem; display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.4s ease-out; }
        .message-success { background: rgba(0, 212, 123, 0.1); border: 1px solid rgba(0, 212, 123, 0.3); color: var(--accent); }
        .message-error { background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); color: var(--danger); }

        .history-section { margin-top: 1.5rem; }
        .history-title { font-size: 0.75rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .history-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 180px; overflow-y: auto; }
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg); border-radius: 10px; font-size: 0.85rem; border: 1px solid var(--border); transition: all 0.2s ease; }
        .history-item:hover { border-color: var(--accent); }

        /* Dashboard */
        .dashboard-header { text-align: center; margin-bottom: 2rem; }
        .dashboard-header h2 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--fg) 0%, var(--muted) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dashboard-header p { color: var(--muted); font-size: 0.9rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent-secondary)); opacity: 0; transition: opacity 0.3s ease; }
        .stat-card:hover::before { opacity: 1; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--accent); }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.75rem; }
        .stat-icon.green { background: rgba(0, 212, 123, 0.15); color: var(--accent); }
        .stat-icon.blue { background: rgba(52, 152, 219, 0.15); color: var(--info); }
        .stat-icon.red { background: rgba(255, 71, 87, 0.15); color: var(--danger); }
        .stat-icon.orange { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--fg); line-height: 1; margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }

        .chart-container { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
        .chart-title { font-size: 1rem; font-weight: 600; color: var(--fg); }
        .chart-filter { display: flex; gap: 0.5rem; }
        .filter-btn { padding: 0.5rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: inherit; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .filter-btn:hover { border-color: var(--accent); color: var(--fg); }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; padding: 1rem 0; gap: 0.5rem; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .bar { width: 100%; max-width: 40px; background: linear-gradient(180deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 6px 6px 0 0; transition: all 0.3s ease; position: relative; min-height: 4px; }
        .bar:hover { filter: brightness(1.2); transform: scaleY(1.02); }
        .bar-value { position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-weight: 600; color: var(--accent); opacity: 0; transition: opacity 0.2s ease; }
        .bar:hover .bar-value { opacity: 1; }
        .bar-label { font-size: 0.7rem; color: var(--muted); text-align: center; }

        /* Table */
        .table-container { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .table-header { display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); }
        .table-title { font-size: 1rem; font-weight: 600; color: var(--fg); }
        .search-box { display: flex; align-items: center; gap: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 0.5rem 1rem; transition: all 0.2s ease; }
        .search-box:focus-within { border-color: var(--accent); }
        .search-box input { background: transparent; border: none; outline: none; color: var(--fg); font-family: inherit; font-size: 0.85rem; width: 150px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { font-size: 0.7rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; background: var(--bg-secondary); }
        .data-table td { font-size: 0.9rem; color: var(--fg); }
        .data-table tbody tr { transition: all 0.2s ease; }
        .data-table tbody tr:hover { background: rgba(0, 212, 123, 0.05); }
        
        .type-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; border-radius: 100px; font-size: 0.75rem; font-weight: 500; }
        .type-badge.checkin { background: rgba(0, 212, 123, 0.15); color: var(--accent); }
        .type-badge.checkout { background: rgba(52, 152, 219, 0.15); color: var(--info); }
        
        .status-tag { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; border-radius: 100px; font-size: 0.75rem; font-weight: 500; }
        .status-tag.tepat { background: rgba(0, 212, 123, 0.15); color: var(--accent); }
        .status-tag.telat { background: rgba(255, 71, 87, 0.15); color: var(--danger); }
        
        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--muted); }
        .pagination { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--border); }
        .page-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--fg); }
        .page-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Settings */
        .shift-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
        .settings-title { font-size: 1.1rem; font-weight: 600; color: var(--fg); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .shift-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg); border-radius: 12px; margin-bottom: 0.75rem; border: 1px solid var(--border); }
        .shift-item:last-child { margin-bottom: 0; }
        .shift-item:hover { border-color: var(--accent); }
        .shift-name { display: flex; align-items: center; gap: 0.75rem; }
        .shift-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .shift-icon.pagi { background: rgba(255, 193, 7, 0.15); }
        .shift-icon.gantung { background: rgba(255, 152, 0, 0.15); }
        .shift-icon.sore { background: rgba(233, 30, 99, 0.15); }
        .shift-icon.malam { background: rgba(63, 81, 181, 0.15); }
        .shift-label { font-weight: 500; color: var(--fg); }
        .shift-time-input { width: 110px; padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--fg); font-family: 'JetBrains Mono', monospace; font-size: 1rem; text-align: center; transition: all 0.2s ease; }
        .shift-time-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        
        .staff-table-container { overflow-x: auto; margin-top: 1rem; }
        .staff-table { width: 100%; border-collapse: collapse; }
        .staff-table th, .staff-table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        .staff-table th { font-size: 0.7rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; background: var(--bg-secondary); }
        .staff-table tbody tr:hover { background: rgba(0, 212, 123, 0.05); }
        .staff-select { padding: 0.5rem 2rem 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--fg); font-family: inherit; font-size: 0.9rem; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7c74' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1rem; }
        .staff-select:focus { outline: none; border-color: var(--accent); }

        .btn-save { width: 100%; padding: 1rem 2rem; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border: none; border-radius: 12px; color: var(--bg); font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 10px 30px var(--accent-glow); }

        .info-card { background: rgba(0, 212, 123, 0.05); border: 1px solid rgba(0, 212, 123, 0.2); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .info-card p { font-size: 0.85rem; color: var(--accent); line-height: 1.5; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }

        @media (max-width: 640px) {
            .main-container { padding: 1rem; }
            .nav-tabs { max-width: 100%; }
            .nav-tab { padding: 0.6rem 0.5rem; font-size: 0.75rem; }
            .nav-tab svg { display: none; }
            .brand-text h1 { font-size: 1.25rem; }
            .time-value { font-size: 1.25rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-value { font-size: 1.5rem; }
            .chart-filter { display: none; }
            .data-table th, .data-table td { padding: 0.75rem 0.5rem; font-size: 0.75rem; }
            .search-box input { width: 80px; }
            .shift-item { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .shift-time-input { width: 100%; }
        }
        .table-wrapper { overflow-x: auto; }
    </style>
</head>
<body>
    <div class="connection-bar" id="connBar"><span id="connText">Loading...</span></div>
    <div class="bg-pattern"><div class="grid-lines"></div></div>
    <div id="particles"></div>

    <main class="main-container">
        <div class="brand">
            <div class="brand-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0a0f0d" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <div class="brand-text"><h1>MarkasWd</h1><span>Staff Attendance System</span></div>
        </div>

        <nav class="nav-tabs" role="tablist">
            <button class="nav-tab active" data-tab="checkin" role="tab" aria-selected="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Absensi
            </button>
            <button class="nav-tab" data-tab="dashboard" role="tab" aria-selected="false">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Dashboard
            </button>
            <button class="nav-tab" data-tab="settings" role="tab" aria-selected="false">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Pengaturan
            </button>
        </nav>

        <!-- Tab: Check-in -->
        <div id="tab-checkin" class="tab-content active" role="tabpanel">
            <div class="flex justify-center">
                <div class="card w-full max-w-md p-6">
                    <div class="status-badge"><span class="status-dot"></span><span>System Online</span></div>
                    <form id="checkinForm">
                        <div class="form-group">
                            <label class="form-label" for="nama">Nama Lengkap</label>
                            <select id="nama" name="nama" class="form-input form-select" required><option value="">Pilih nama...</option></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jabatan">Jabatan</label>
                            <input type="text" id="jabatan" name="jabatan" class="form-input" readonly placeholder="Otomatis terisi" style="background: var(--bg-secondary); opacity: 0.8;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="shift">Shift Ditugaskan</label>
                            <input type="text" id="shift" name="shift" class="form-input" readonly placeholder="Otomatis terisi" style="background: var(--bg-secondary); opacity: 0.8;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="tipe">Tipe Absensi</label>
                            <select id="tipe" name="tipe" class="form-input form-select" required>
                                <option value="Check-in">Check-in (Masuk)</option>
                                <option value="Check-out">Check-out (Pulang)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Waktu Sekarang</label>
                            <div class="time-display">
                                <div>
                                    <div class="time-value mono" id="currentTime">--:--:--</div>
                                    <div class="date-value" id="currentDate">Loading...</div>
                                </div>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </div>
                        </div>
                        <div class="form-group" id="statusGroup" style="display: none;">
                            <label class="form-label">Status Kehadiran</label>
                            <div class="shift-info">
                                <div>
                                    <div class="shift-info-label">Batas waktu</div>
                                    <div class="shift-info-value" id="shiftDeadline">--:--</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="shift-info-label">Status</div>
                                    <div class="shift-info-value" id="attendanceStatus">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="catatan">Catatan (Opsional)</label>
                            <input type="text" id="catatan" name="catatan" class="form-input" placeholder="Ada hal yang perlu dicatat?">
                        </div>
                        <button type="submit" class="btn-checkin" id="submitBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span id="btnText">Submit Absensi</span>
                        </button>
                        <div id="messageContainer"></div>
                    </form>
                    <div class="history-section">
                        <div class="history-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Riwayat Hari Ini</div>
                        <div class="history-list" id="historyList"><div class="history-item" style="color: var(--muted); justify-content: center;">Memuat data...</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Dashboard & Settings (Same as previous) -->
        <div id="tab-dashboard" class="tab-content" role="tabpanel">
            <div class="max-w-5xl mx-auto">
                <div class="dashboard-header"><h2>Dashboard Riwayat Absensi</h2><p>Pantau aktivitas kehadiran staff</p></div>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card"><div class="stat-icon green"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Absensi</div></div>
                    <div class="stat-card"><div class="stat-icon blue"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></div><div class="stat-value" id="statCheckin">0</div><div class="stat-label">Check-in</div></div>
                    <div class="stat-card"><div class="stat-icon red"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="stat-value" id="statLate">0</div><div class="stat-label">Terlambat</div></div>
                    <div class="stat-card"><div class="stat-icon orange"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><div class="stat-value" id="statStaff">0</div><div class="stat-label">Staff Aktif</div></div>
                </div>
                <div class="chart-container"><div class="chart-header"><h3 class="chart-title">Aktivitas Mingguan</h3><div class="chart-filter"><button class="filter-btn active" data-filter="week">Minggu Ini</button></div></div><div class="bar-chart" id="barChart"></div></div>
                <div class="table-container"><div class="table-header"><h3 class="table-title">Riwayat Absensi Lengkap</h3><div class="search-box"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--muted);"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><input type="text" id="searchInput" placeholder="Cari nama..."></div></div><div class="table-wrapper"><table class="data-table"><thead><tr><th>Nama</th><th>Jabatan</th><th>Shift</th><th>Tipe</th><th>Waktu</th><th>Status</th><th>Tanggal</th></tr></thead><tbody id="tableBody"></tbody></table></div><div class="pagination" id="pagination"></div></div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content" role="tabpanel">
            <div class="max-w-3xl mx-auto">
                <div class="dashboard-header"><h2>Pengaturan Sistem</h2><p>Atur jadwal shift dan penugasan staff</p></div>
                <div class="shift-card">
                    <div class="settings-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Jadwal Mulai Shift</div>
                    <div class="shift-item"><div class="shift-name"><div class="shift-icon pagi"></div><span class="shift-label">Shift Pagi</span></div><input type="time" id="settingPagi" class="shift-time-input" value="07:45"></div>
                    <div class="shift-item"><div class="shift-name"><div class="shift-icon gantung"></div><span class="shift-label">Shift Gantung</span></div><input type="time" id="settingGantung" class="shift-time-input" value="11:45"></div>
                    <div class="shift-item"><div class="shift-name"><div class="shift-icon sore"></div><span class="shift-label">Shift Sore</span></div><input type="time" id="settingSore" class="shift-time-input" value="15:45"></div>
                    <div class="shift-item"><div class="shift-name"><div class="shift-icon malam"></div><span class="shift-label">Shift Malam</span></div><input type="time" id="settingMalam" class="shift-time-input" value="21:45"></div>
                </div>
                <div class="shift-card">
                    <div class="settings-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>Penugasan Shift Staff</div>
                    <div class="staff-table-container"><table class="staff-table"><thead><tr><th>Nama Staff</th><th>Jabatan</th><th>Shift Ditugaskan</th></tr></thead><tbody id="staffTableBody"></tbody></table></div>
                    <button type="button" class="btn-save" id="saveSettings"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Simpan Pengaturan</button>
                    <div class="info-card"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent); flex-shrink: 0;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg><p>Pengaturan ini bersifat lokal di masing-masing perangkat. Untuk sinkron konfigurasi, bagikan file HTML ini dengan pengaturan yang sudah disimpan.</p></div>
                </div>
            </div>
        </div>

        <p style="margin-top: 2rem; font-size: 0.75rem; color: var(--muted); text-align: center;">MarkasWd Staff Attendance System v5.0 (Cloud Sync)</p>
    </main>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        
        // PASTIKAN ANDA MENGGANTI URL INI DENGAN URL WEB APP DARI LANGKAH 1
        const API_URL = 'https://script.google.com/macros/s/AKfycbwJ4mGUn0rNcfBUGdj4-rL3BdCnUOII27YFzqnMEpNMehezqiDDRFxKnNnt3q1tZYUs/exec'; 
        
        const CONFIG = { ITEMS_PER_PAGE: 8 };

        // Default Data (digunakan jika localStorage kosong)
        const DEFAULT_STAFF_DATA = {
            "JUWAN": { jabatan: "CS", shift: "Pagi" },
            "MUHAMMAD RIDWAN": { jabatan: "CS", shift: "Pagi" },
            "LEO SANDRO NAIBAHO": { jabatan: "CS", shift: "Gantung" },
            "NOVAL MUTTAWALI HAKIM": { jabatan: "CS", shift: "Gantung" },
            "TEUKU AULIA PUTRA": { jabatan: "Kasir", shift: "Sore" },
            "SUKMA SARI DEWI": { jabatan: "Kasir", shift: "Sore" },
            "MUNTAS FAZIRA": { jabatan: "Kasir", shift: "Malam" },
            "ZEFRI AWI DONGAN TAMPUBOLON": { jabatan: "Kasir", shift: "Malam" },
            "SHI RONY": { jabatan: "Kasir", shift: "Pagi" }
        };

        const DEFAULT_SHIFT_SCHEDULES = {
            "Pagi": "07:45", "Gantung": "11:45", "Sore": "15:45", "Malam": "21:45"
        };

        // State
        let staffData = {};
        let shiftSchedules = {};
        let attendanceHistory = [];
        let currentPage = 1;
        let searchQuery = '';

        // DOM References
        let els = {};

        // ============================================================
        // INITIALIZATION & SYNC
        // ============================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Cache DOM
            els = {
                connBar: document.getElementById('connBar'),
                connText: document.getElementById('connText'),
                timeDisplay: document.getElementById('currentTime'),
                dateDisplay: document.getElementById('currentDate'),
                form: document.getElementById('checkinForm'),
                submitBtn: document.getElementById('submitBtn'),
                btnText: document.getElementById('btnText'),
                msgContainer: document.getElementById('messageContainer'),
                historyList: document.getElementById('historyList'),
                tableBody: document.getElementById('tableBody'),
                pagination: document.getElementById('pagination'),
                barChart: document.getElementById('barChart'),
                namaSelect: document.getElementById('nama'),
                jabatanInput: document.getElementById('jabatan'),
                shiftInput: document.getElementById('shift'),
                tipeSelect: document.getElementById('tipe'),
                statusGroup: document.getElementById('statusGroup'),
                shiftDeadline: document.getElementById('shiftDeadline'),
                attendanceStatus: document.getElementById('attendanceStatus'),
                searchInput: document.getElementById('searchInput'),
                staffTableBody: document.getElementById('staffTableBody')
            };

            loadLocalConfig(); // Load config from localStorage first
            createParticles();
            updateTime();
            setInterval(updateTime, 1000);
            initTabs();
            initForm();
            renderSettings();
            initFilters();
            
            document.getElementById('saveSettings').addEventListener('click', handleSaveSettings);
            if(els.form) els.form.addEventListener('submit', handleSubmit);

            // Start Sync Process
            syncDataFromCloud();
        });

        // ============================================================
        // NETWORK & SYNC FUNCTIONS
        // ============================================================

        function setConnectionStatus(status) {
            if(status === 'online') {
                els.connBar.className = 'connection-bar online';
                els.connText.textContent = 'ONLINE - DATA SYNCED';
            } else if (status === 'offline') {
                els.connBar.className = 'connection-bar offline';
                els.connText.textContent = 'OFFLINE - DATA LOKAL';
            } else {
                els.connBar.className = 'connection-bar';
                els.connBar.style.display = 'none';
            }
        }

        async function syncDataFromCloud() {
            if(API_URL === 'MASUKKAN_URL_GOOGLE_APPS_SCRIPT_ANDINI' || !API_URL.includes('script.google.com')) {
                console.warn("API URL belum diset. Menggunakan mode offline/local.");
                setConnectionStatus('offline');
                loadLocalHistory();
                return;
            }

            try {
                const response = await fetch(`${API_URL}?action=getData`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    attendanceHistory = data;
                    localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
                    setConnectionStatus('online');
                    console.log("Data berhasil disinkronkan dari Cloud");
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error("Gagal sync dari cloud:", error);
                setConnectionStatus('offline');
                loadLocalHistory();
            }

            renderMiniHistory();
            renderDashboard(); // Render after sync attempt
        }

        function loadLocalHistory() {
            const storedHistory = localStorage.getItem('attendanceHistory');
            attendanceHistory = storedHistory ? JSON.parse(storedHistory) : [];
        }

        function loadLocalConfig() {
            const storedStaff = localStorage.getItem('staffData');
            staffData = storedStaff ? JSON.parse(storedStaff) : { ...DEFAULT_STAFF_DATA };
            
            const storedSchedules = localStorage.getItem('shiftSchedules');
            shiftSchedules = storedSchedules ? JSON.parse(storedSchedules) : { ...DEFAULT_SHIFT_SCHEDULES };
        }

        async function postDataToCloud(payload) {
            if(API_URL === 'https://script.google.com/macros/s/AKfycbwJ4mGUn0rNcfBUGdj4-rL3BdCnUOII27YFzqnMEpNMehezqiDDRFxKnNnt3q1tZYUs/exec' || !API_URL.includes('script.google.com')) {
                return { status: 'success', message: 'Saved locally (No API)' };
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script requires no-cors for simple POST
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                // Since mode is no-cors, we can't read the response, assume success if no error
                return { status: 'success' };
            } catch (error) {
                console.error("Error posting data:", error);
                return { status: 'error', message: error.toString() };
            }
        }

        // ============================================================
        // CORE FUNCTIONS (Time, UI, Particles)
        // ============================================================
        
        function createParticles() {
            const container = document.getElementById('particles');
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = `${Math.random() * 100}%`;
                p.style.animationDelay = `${Math.random() * 20}s`;
                container.appendChild(p);
            }
        }

        function updateTime() {
            if(!els.timeDisplay) return;
            const now = new Date();
            els.timeDisplay.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            els.dateDisplay.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            updateAttendanceStatus();
        }

        // ============================================================
        // FORM LOGIC
        // ============================================================
        
        function initForm() {
            els.namaSelect.innerHTML = '<option value="">Pilih nama...</option>';
            Object.keys(staffData).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                els.namaSelect.appendChild(opt);
            });

            els.namaSelect.addEventListener('change', () => {
                const name = els.namaSelect.value;
                if (name && staffData[name]) {
                    els.jabatanInput.value = staffData[name].jabatan;
                    els.shiftInput.value = staffData[name].shift;
                    updateAttendanceStatus();
                } else {
                    els.jabatanInput.value = '';
                    els.shiftInput.value = '';
                    els.statusGroup.style.display = 'none';
                }
            });
            els.tipeSelect.addEventListener('change', updateAttendanceStatus);
        }

        function updateAttendanceStatus() {
            const name = els.namaSelect.value;
            const tipe = els.tipeSelect.value;
            
            if (name && staffData[name] && tipe === 'Check-in') {
                els.statusGroup.style.display = 'block';
                const shiftName = staffData[name].shift;
                const deadline = shiftSchedules[shiftName] || '00:00';
                els.shiftDeadline.textContent = `${deadline} WIB`;

                const now = new Date();
                const currentMins = now.getHours() * 60 + now.getMinutes();
                const [dh, dm] = deadline.split(':').map(Number);
                const deadlineMins = dh * 60 + dm;

                if (currentMins > deadlineMins) {
                    els.attendanceStatus.textContent = 'TELAT';
                    els.attendanceStatus.className = 'shift-info-value late';
                } else {
                    els.attendanceStatus.textContent = 'TEPAT WAKTU';
                    els.attendanceStatus.className = 'shift-info-value on-time';
                }
            } else {
                els.statusGroup.style.display = 'none';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const nama = els.namaSelect.value;
            const tipe = els.tipeSelect.value;
            const catatan = document.getElementById('catatan').value.trim();

            if (!nama) { showMessage('error', 'Pilih nama terlebih dahulu.'); return; }

            els.submitBtn.disabled = true;
            els.btnText.innerHTML = '<span class="spinner"></span>Mengirim...';

            const now = new Date();
            const data = {
                action: 'checkin',
                nama: nama,
                jabatan: staffData[nama].jabatan,
                shift: staffData[nama].shift,
                tipe: tipe,
                waktu: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                tanggal: now.toLocaleDateString('id-ID'),
                status: tipe === 'Check-in' ? checkLateStatus(staffData[nama].shift, now) : '-',
                catatan: catatan,
                timestamp: now.toISOString()
            };

            // 1. Save to Local First (Optimistic UI)
            attendanceHistory.unshift(data);
            localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
            
            // 2. Try to Sync to Cloud
            const result = await postDataToCloud(data);
            
            if (result.status === 'success') {
                showMessage('success', `Berhasil! Data disimpan & disinkronkan.`);
                if(API_URL.includes('script.google.com')) setConnectionStatus('online');
            } else {
                showMessage('error', 'Gagal sinkron ke cloud, data disimpan lokal.');
                setConnectionStatus('offline');
            }

            // Reset Form
            els.namaSelect.value = '';
            els.jabatanInput.value = '';
            els.shiftInput.value = '';
            document.getElementById('catatan').value = '';
            els.statusGroup.style.display = 'none';

            renderMiniHistory();
            renderDashboard();
            els.submitBtn.disabled = false;
            els.btnText.innerHTML = 'Submit Absensi';
        }

        function checkLateStatus(shiftName, dateObj) {
            const deadline = shiftSchedules[shiftName];
            if (!deadline) return '-';
            const [dh, dm] = deadline.split(':').map(Number);
            const currentMins = dateObj.getHours() * 60 + dateObj.getMinutes();
            const deadlineMins = dh * 60 + dm;
            return currentMins > deadlineMins ? 'Telat' : 'Tepat Waktu';
        }

        function showMessage(type, text) {
            const icon = type === 'success' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            els.msgContainer.innerHTML = `<div class="message message-${type}">${icon}<span>${text}</span></div>`;
        }

        // ============================================================
        // SETTINGS LOGIC
        // ============================================================
        
        function renderSettings() {
            document.getElementById('settingPagi').value = shiftSchedules['Pagi'];
            document.getElementById('settingGantung').value = shiftSchedules['Gantung'];
            document.getElementById('settingSore').value = shiftSchedules['Sore'];
            document.getElementById('settingMalam').value = shiftSchedules['Malam'];

            els.staffTableBody.innerHTML = Object.keys(staffData).map(name => {
                const info = staffData[name];
                return `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>${info.jabatan}</td>
                        <td>
                            <select class="staff-select" data-name="${name}">
                                <option value="Pagi" ${info.shift === 'Pagi' ? 'selected' : ''}>Pagi</option>
                                <option value="Gantung" ${info.shift === 'Gantung' ? 'selected' : ''}>Gantung</option>
                                <option value="Sore" ${info.shift === 'Sore' ? 'selected' : ''}>Sore</option>
                                <option value="Malam" ${info.shift === 'Malam' ? 'selected' : ''}>Malam</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function handleSaveSettings() {
            shiftSchedules = {
                "Pagi": document.getElementById('settingPagi').value,
                "Gantung": document.getElementById('settingGantung').value,
                "Sore": document.getElementById('settingSore').value,
                "Malam": document.getElementById('settingMalam').value
            };

            document.querySelectorAll('.staff-select').forEach(select => {
                const name = select.dataset.name;
                if (staffData[name]) staffData[name].shift = select.value;
            });

            localStorage.setItem('staffData', JSON.stringify(staffData));
            localStorage.setItem('shiftSchedules', JSON.stringify(shiftSchedules));
            initForm(); // Refresh form logic with new data
            
            const btn = document.getElementById('saveSettings');
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Tersimpan!';
            setTimeout(() => { btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Simpan Pengaturan'; }, 1500);
        }

        // ============================================================
        // DASHBOARD & UI RENDERING (Same as before)
        // ============================================================
        
        function initTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    
                    const target = document.getElementById(`tab-${tab.dataset.tab}`);
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    target.classList.add('active');

                    if (tab.dataset.tab === 'dashboard') renderDashboard();
                    if (tab.dataset.tab === 'settings') renderSettings();
                });
            });
        }

        function initFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderChart();
                });
            });
            if(els.searchInput) {
                els.searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value;
                    currentPage = 1;
                    renderTable();
                });
            }
        }

        function renderMiniHistory() {
            const today = new Date().toDateString();
            const todayData = attendanceHistory.filter(i => new Date(i.timestamp).toDateString() === today);
            
            if (todayData.length === 0) {
                els.historyList.innerHTML = '<div class="history-item" style="color: var(--muted); justify-content: center;">Belum ada data hari ini</div>';
                return;
            }
            els.historyList.innerHTML = todayData.slice(0, 5).map(i => `
                <div class="history-item">
                    <span class="history-name">${i.nama}</span>
                    <span class="history-time mono">${i.tipe} - ${i.waktu.substring(0,5)}</span>
                </div>
            `).join('');
        }

        function renderDashboard() {
            renderStats();
            renderChart();
            renderTable();
        }

        function renderStats() {
            animateVal('statTotal', attendanceHistory.length);
            animateVal('statCheckin', attendanceHistory.filter(i => i.tipe === 'Check-in').length);
            animateVal('statLate', attendanceHistory.filter(i => i.status === 'Telat').length);
            animateVal('statStaff', new Set(attendanceHistory.map(i => i.nama)).size);
        }

        function animateVal(id, end) {
            const el = document.getElementById(id);
            if(!el) return;
            const start = parseInt(el.textContent) || 0;
            const dur = 500;
            const t0 = performance.now();
            function step(t) {
                const prog = Math.min((t - t0) / dur, 1);
                el.textContent = Math.round(start + (end - start) * prog);
                if (prog < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        function renderChart() {
            const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today); d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('id-ID');
                const count = attendanceHistory.filter(x => x.tanggal === dateStr).length;
                data.push({ day: days[(d.getDay() + 6) % 7], count });
            }

            const max = Math.max(...data.map(d => d.count), 1);
            els.barChart.innerHTML = data.map(d => `
                <div class="bar-group">
                    <div class="bar" style="height: ${Math.max((d.count/max)*100, 4)}%">
                        <span class="bar-value">${d.count}</span>
                    </div>
                    <span class="bar-label">${d.day}</span>
                </div>
            `).join('');
        }

        function renderTable() {
            let filtered = attendanceHistory;
            if (searchQuery) filtered = filtered.filter(i => i.nama.toLowerCase().includes(searchQuery.toLowerCase()));
            
            const totalPg = Math.ceil(filtered.length / CONFIG.ITEMS_PER_PAGE);
            if (currentPage > totalPg) currentPage = Math.max(1, totalPg);
            const start = (currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const pageData = filtered.slice(start, start + CONFIG.ITEMS_PER_PAGE);

            if (!pageData.length) {
                els.tableBody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><p>Tidak ada data</p></div></td></tr>`;
            } else {
                els.tableBody.innerHTML = pageData.map(i => `
                    <tr>
                        <td><strong>${i.nama}</strong></td>
                        <td>${i.jabatan}</td>
                        <td>${i.shift}</td>
                        <td><span class="type-badge ${i.tipe === 'Check-in' ? 'checkin' : 'checkout'}">${i.tipe}</span></td>
                        <td class="mono">${i.waktu}</td>
                        <td>${i.status !== '-' ? `<span class="status-tag ${i.status === 'Tepat Waktu' ? 'tepat' : 'telat'}">${i.status}</span>` : '-'}</td>
                        <td>${i.tanggal}</td>
                    </tr>
                `).join('');
            }
            renderPagination(totalPg);
        }

        function renderPagination(totalPg) {
            if (totalPg <= 1) { els.pagination.innerHTML = ''; return; }
            let h = `<button class="page-btn" data-p="${currentPage-1}" ${currentPage===1?'disabled':''}><</button>`;
            for(let i=1; i<=totalPg; i++) {
                if(i===1 || i===totalPg || (i>=currentPage-1 && i<=currentPage+1)) h += `<button class="page-btn ${i===currentPage?'active':''}" data-p="${i}">${i}</button>`;
                else if(i===currentPage-2 || i===currentPage+2) h += `...`;
            }
            h += `<button class="page-btn" data-p="${currentPage+1}" ${currentPage===totalPg?'disabled':''}>></button>`;
            els.pagination.innerHTML = h;
            els.pagination.querySelectorAll('.page-btn').forEach(b => {
                b.onclick = () => { if(!b.disabled) { currentPage = parseInt(b.dataset.p); renderTable(); }};
            });
        }
    </script>
</body>
</html>

